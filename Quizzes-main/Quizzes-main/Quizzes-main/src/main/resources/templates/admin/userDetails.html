<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" th:href="@{/assets/img/apple-icon.png}">
  <link rel="icon" type="image/png" th:href="@{/assets/img/favicon.png}">
  <title>User Profile - Quiz App</title>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <link th:href="@{/assets/css/nucleo-icons.css}" rel="stylesheet" />
  <link th:href="@{/assets/css/nucleo-svg.css}" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link id="pagestyle" th:href="@{/assets/css/material-dashboard.css?v=3.2.0}" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      position: relative;
    }

    .main-content {
      min-height: calc(100vh - 60px);
      position: relative;
      padding-bottom: 60px;
    }

    .profile-card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      background-color: #fff;
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .profile-image {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .profile-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .profile-row div {
      flex: 1;
    }

    .profile-info h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #344767;
      margin: 0;
    }

    .profile-info p {
      font-size: 1rem;
      color: #000000;
      margin: 0;
    }

    .profile-info .badge {
      font-size: 0.75rem;
      padding: 0.5em 1em;
      border-radius: 6px;
    }

    .bg-role-user { background: linear-gradient(90deg, #3498db, #2980b9); color: white; }
    .bg-role-admin { background: linear-gradient(90deg, #9b59b6, #8e44ad); color: white; }
    .bg-end-time-na { 
      background: #cce5ff; 
      color: #cce5ff; 
      padding: 0.075rem 0.1rem;
      border-radius: 4px;
      display: inline-block;
      min-width: 190px;
    }
    .bg-id { background: #000000; color: white; padding: 0.25rem 0.5rem; border-radius: 6px; }

    /* Định dạng badge trong cột Status của Quiz Attempts */
    .status-badge {
      display: inline-block;
      width: 120px; /* Độ rộng cố định cho tất cả badge */
      text-align: center; /* Căn giữa nội dung trong badge */
      font-size: 0.75rem;
      padding: 0.5em 0; /* Padding trên dưới cố định, không padding trái phải để giữ độ rộng */
      border-radius: 6px;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .card-header h6 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #344767;
      text-align: center;
    }

    th, td {
      text-align: center;
      vertical-align: middle;
      padding: 10px;
    }

    th {
      font-size: 0.875rem;
      font-weight: 600;
      color: #344767;
      text-transform: none;
    }

    .action-btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border-radius: 6px;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #f8f9fa;
      z-index: 1000;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container-fluid {
      padding: 2rem 3rem;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <a class="navbar-brand px-4 py-3 m-0" th:href="@{/admin/dashboard}">
        <img th:src="@{/assets/img/logo-ct-dark.png}" class="navbar-brand-img" width="26" height="26" alt="main_logo">
        <span class="ms-1 text-sm text-dark">Quiz Admin</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" th:href="@{/admin/dashboard}">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-dark text-white" th:href="@{/admin/adminUser}">
            <i class="material-symbols-rounded opacity-5">person</i>
            <span class="nav-link-text ms-1">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" th:href="@{/admin/quizzes}">
            <i class="material-symbols-rounded opacity-5">quiz</i>
            <span class="nav-link-text ms-1">Quizzes</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" th:href="@{/admin/categories}">
            <i class="material-symbols-rounded opacity-5">category</i>
            <span class="nav-link-text ms-1">Categories</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" th:href="@{/admin/logout}">
            <i class="material-symbols-rounded opacity-5">logout</i>
            <span class="nav-link-text ms-1">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="/admin">Admin</a></li>
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="/admin/adminUser">Users</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">User Profile</li>
          </ol>
        </nav>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Profile Section -->
        <div class="col-12 mb-4">
          <div class="profile-card">
            <img th:if="${user.profileImage != null}"
                 th:src="@{'/assets/img/' + ${user.profileImage}}"
                 class="profile-image"
                 alt="User Profile Image" />
            <img th:unless="${user.profileImage != null}"
                 th:src="@{/assets/img/default-avatar.png}"
                 class="profile-image"
                 alt="Default Profile Image" />
            <div class="profile-info">
              <div class="profile-row">
                <div>
                  <h3 th:text="${user.username ?: 'N/A'}">N/A</h3>
                </div>
                <div>
                  <p>
                    <strong>   Role: </strong> 
                    <span class="badge badge-sm" 
                          th:classappend="${user.role == 'ROLE_USER' ? 'bg-role-user' : 'bg-role-admin'}"
                          th:text="${user.role ?: 'N/A'}">N/A</span>
                  </p>
                </div>
              </div>
              <div class="profile-row">
                <div>
                  <p><strong>Email:</strong> <span th:text="${user.email ?: 'N/A'}">N/A</span></p>
                </div>
                <div>
                  <p>
                    <strong>Status:</strong> 
                    <span class="badge badge-sm" 
                          th:classappend="${user.isActive ? 'bg-gradient-success' : 'bg-gradient-secondary'}"
                          th:text="${user.isActive ? 'Activated' : 'Not Activated'}">N/A</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Rankings -->
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <h6>User Rankings</h6>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th>Ranking Id</th>
                      <th>User Id</th>
                      <th>Username</th>
                      <th>Total Score</th>
                      <th>Quizzes Completed</th>
                      <th>Correct Answers</th>
                      <th>Rank Position</th>
                      <th>Created At</th>
                      <th>Updated At</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:if="${ranking != null}">
                      <td><span class="badge badge-sm bg-id" th:text="${ranking.rankingId ?: 'N/A'}">N/A</span></td>
                      <td><span class="badge badge-sm bg-id" th:text="${ranking.userId ?: 'N/A'}">N/A</span></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${ranking.username ?: 'N/A'}">N/A</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${ranking.totalScore != null ? ranking.totalScore : 0}">0</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${ranking.quizzesCompleted != null ? ranking.quizzesCompleted : 0}">0</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${ranking.correctAnswers != null ? ranking.correctAnswers : 0}">0</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${ranking.rankPosition != null ? ranking.rankPosition : 'N/A'}">N/A</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${#dates.format(ranking.createdAt, 'dd/MM/yyyy') ?: 'N/A'}">N/A</p></td>
                      <td><p class="text-xs font-weight-bold mb-0" th:text="${#dates.format(ranking.updatedAt, 'dd/MM/yyyy') ?: 'N/A'}">N/A</p></td>
                    </tr>
                    <tr th:unless="${ranking != null}">
                      <td colspan="9" class="text-center">No ranking data available</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Quiz Attempts -->
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <h6>Quiz Attempts</h6>
            </div>
            <div class="card-body px-0 pb-2">
              <div class="table-responsive">
                <table class="table align-items-center mb-0">
                  <thead>
                    <tr>
                      <th>Quiz Title</th>
                      <th>Start Time</th>
                      <th>End Time</th>
                      <th>Score</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="attempt : ${attempts}" th:if="${attempts != null and #lists.size(attempts) > 0}">
                      <td>
                        <h6 class="mb-0 text-sm" th:text="${quizMap[attempt.quizzId] ?: 'N/A'}">N/A</h6>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0" th:text="${attempt.startTime ?: 'N/A'}">N/A</p>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0" 
                           th:classappend="${attempt.endTime == null ? 'bg-end-time-na' : ''}"
                           th:text="${attempt.endTime ?: 'N/A'}">N/A</p>
                      </td>
                      <td>
                        <p class="text-xs font-weight-bold mb-0" th:text="${attempt.score != null ? attempt.score : 0}">0</p>
                      </td>
                      <td>
                        <span class="badge badge-sm status-badge" 
                              th:classappend="${attempt.status == 'IN_PROGRESS' ? 'bg-warning' : (attempt.status == 'COMPLETED' ? 'bg-success' : 'bg-danger')}"
                              th:text="${attempt.status ?: 'N/A'}">N/A</span>
                      </td>
                      <td>
                        <a th:href="@{/admin/users/attempt-details(attemptId=${attempt.attemptId}, userId=${user.userId})}" 
                           class="btn btn-sm btn-primary action-btn">
                          <i class="material-symbols-rounded">visibility</i> Details
                        </a>
                      </td>
                    </tr>
                    <tr th:unless="${attempts != null and #lists.size(attempts) > 0}">
                      <td colspan="6" class="text-center">No quiz attempts available</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer">
        <div class="container-fluid">
          <div class="copyright text-center text-sm text-muted">
            © <script>document.write(new Date().getFullYear())</script>,
            Quiz App Admin Panel
          </div>
        </div>
      </footer>
    </div>
  </main>

  <script th:src="@{/assets/js/core/popper.min.js}"></script>
  <script th:src="@{/assets/js/core/bootstrap.min.js}"></script>
  <script th:src="@{/assets/js/plugins/perfect-scrollbar.min.js}"></script>
  <script th:src="@{/assets/js/plugins/smooth-scrollbar.min.js}"></script>
  <script th:src="@{/assets/js/material-dashboard.min.js?v=3.2.0}"></script>
</body>

</html>